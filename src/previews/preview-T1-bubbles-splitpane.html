<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SLAP! — Preview T1: Split Pane + Morph Bubble System</title>
<style>
/* ── Reset ─────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ── Motion Tokens (Mechanical + CRT personality) ──────── */
:root {
  --ease-enter: cubic-bezier(0.22, 0.61, 0.36, 1);
  --ease-exit: cubic-bezier(0.4, 0, 0.6, 1);
  --ease-emphasis: cubic-bezier(0.4, 0, 0.2, 1);
  --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
  --duration-micro: 150ms;
  --duration-small: 250ms;
  --duration-medium: 400ms;
  --duration-page: 800ms;
  --stagger-delay: 60ms;

  --color-bg: #1A1A2E;
  --color-surface: #222240;
  --color-accent: #FFD000;
  --color-text: #F5F0E1;
  --color-text-dim: rgba(245, 240, 225, 0.5);
  --color-border: rgba(245, 240, 225, 0.12);
  --color-green: #6BCB77;
  --color-yellow: #FFD93D;
  --color-red: #FF6B6B;
  --font: 'Courier New', monospace;

  --panel-width: 380px;
}

@media (prefers-reduced-motion: reduce) {
  :root {
    --duration-micro: 0ms;
    --duration-small: 0ms;
    --duration-medium: 0ms;
    --duration-page: 0ms;
    --stagger-delay: 0ms;
  }
}

body {
  font-family: var(--font);
  background: var(--color-bg);
  color: var(--color-text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ── Info Banner ───────────────────────────────────────── */
.info-banner {
  position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
  background: var(--color-accent); color: #1A1A2E;
  font-size: 0.7rem; font-weight: 700; text-align: center;
  padding: 6px 16px; letter-spacing: 0.06em;
}
.info-banner code { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 3px; }

/* ── Controls ──────────────────────────────────────────── */
.controls {
  position: fixed; top: 28px; right: 16px; z-index: 9998;
  display: flex; gap: 6px;
}
.controls button {
  font-family: var(--font); font-size: 0.6rem; font-weight: 700;
  padding: 4px 10px; border: 1px solid var(--color-border);
  background: var(--color-surface); color: var(--color-text-dim);
  border-radius: 3px; cursor: pointer; transition: all var(--duration-micro);
  letter-spacing: 0.04em;
}
.controls button:hover, .controls button.active {
  color: var(--color-accent); border-color: var(--color-accent);
}

/* ── Mock Page Content — COMPRESSES when panel opens ──── */
.mock-page {
  padding: 56px 80px 120px 24px;
  max-width: 900px;
  transition: opacity var(--duration-medium) var(--ease-exit),
              margin-right var(--duration-medium) var(--ease-enter),
              max-width var(--duration-medium) var(--ease-enter);
}
.mock-page.dimmed { opacity: 0.4; }
.mock-page.compressed {
  margin-right: calc(var(--panel-width) + 20px);
  opacity: 1;
}

.mock-page h1 {
  font-size: clamp(2rem, 4vw, 3.5rem);
  font-weight: 700; letter-spacing: -0.02em;
  margin-bottom: 1rem; line-height: 1.1;
}
.mock-page .subtitle {
  font-size: 0.85rem; color: var(--color-text-dim);
  margin-bottom: 2.5rem; line-height: 1.6;
  max-width: 560px;
}
.mock-section {
  margin-bottom: 2rem; padding: 1.5rem;
  border: 1px solid var(--color-border);
  border-radius: 4px; position: relative;
  transition: box-shadow var(--duration-small) var(--ease-enter),
              border-color var(--duration-small) var(--ease-enter);
}
.mock-section .section-label {
  font-size: 0.55rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--color-accent); margin-bottom: 0.8rem;
}
.mock-section p {
  font-size: 0.75rem; line-height: 1.7; color: var(--color-text-dim);
}
.mock-section.highlighted {
  border-color: var(--highlight-color, var(--color-accent));
  box-shadow: 0 0 0 2px var(--highlight-color, var(--color-accent)), 0 0 20px rgba(255,208,0,0.15);
}

/* Section annotation overlay */
.section-annotation {
  position: absolute; top: -10px; right: 12px;
  font-size: 0.5rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.06em; padding: 2px 8px; border-radius: 3px;
  background: var(--highlight-color, var(--color-accent));
  color: #1A1A2E; pointer-events: none;
  opacity: 0; transform: translateY(4px);
  transition: opacity var(--duration-micro) var(--ease-enter),
              transform var(--duration-micro) var(--ease-enter);
}
.mock-section.highlighted .section-annotation {
  opacity: 1; transform: translateY(0);
}

/* ══════════════════════════════════════════════════════════
   TIER 1: BUBBLE RAIL
   ══════════════════════════════════════════════════════════ */
.bubble-rail {
  position: fixed;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 800;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  transition: right var(--duration-medium) var(--ease-enter);
}
/* Rail shifts right when panel is open to stay outside panel */
.bubble-rail.shifted {
  right: calc(var(--panel-width) + 12px);
}

/* ── Aggregate Summary ─────────────────────────────────── */
.aggregate-summary {
  text-align: center;
  margin-bottom: 6px;
  padding: 6px 4px;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  background: rgba(34,34,64,0.8);
  min-width: 52px;
  transition: opacity var(--duration-small) var(--ease-enter);
}
.aggregate-summary.hidden { opacity: 0; pointer-events: none; }
.aggregate-score {
  font-size: 1rem; font-weight: 800; color: var(--color-text);
  line-height: 1;
}
.aggregate-score small {
  font-size: 0.45rem; color: var(--color-text-dim); font-weight: 700;
}
.aggregate-lights {
  display: flex; gap: 2px; justify-content: center; margin-top: 3px;
}
.aggregate-lights .dot {
  width: 5px; height: 5px; border-radius: 50%;
}
.aggregate-lights .dot.red { background: var(--color-red); }
.aggregate-lights .dot.yellow { background: var(--color-yellow); }
.aggregate-lights .dot.green { background: var(--color-green); }

/* ── Mode Toggle ───────────────────────────────────────── */
.mode-toggle {
  display: flex; gap: 0;
  background: var(--color-surface);
  border-radius: 9999px;
  border: 1px solid var(--color-border);
  overflow: hidden;
  margin-bottom: 6px;
}
.mode-toggle button {
  font-family: var(--font); font-size: 0.45rem; font-weight: 700;
  padding: 4px 8px; border: none; cursor: pointer;
  background: transparent; color: var(--color-text-dim);
  letter-spacing: 0.06em; white-space: nowrap;
  transition: all var(--duration-micro);
}
.mode-toggle button.active {
  background: var(--color-accent);
  color: #1A1A2E;
}

.bubble-rail .rail-divider {
  width: 1px; height: 12px; background: var(--color-border);
  margin: 2px 0;
}

/* Individual bubble */
.bubble {
  width: 40px; height: 40px;
  border-radius: 50%;
  overflow: hidden;
  cursor: pointer;
  position: relative;
  border: 2px solid transparent;
  transition: transform var(--duration-micro) var(--ease-enter),
              border-color var(--duration-micro) var(--ease-enter),
              box-shadow var(--duration-micro) var(--ease-enter);
  opacity: 0;
  animation: bubbleEnter var(--duration-medium) var(--ease-enter) forwards;
}
.bubble:nth-child(1)  { animation-delay: calc(var(--stagger-delay) * 0); }
.bubble:nth-child(2)  { animation-delay: calc(var(--stagger-delay) * 1); }
.bubble:nth-child(3)  { animation-delay: calc(var(--stagger-delay) * 2); }
.bubble:nth-child(4)  { animation-delay: calc(var(--stagger-delay) * 3); }
.bubble:nth-child(5)  { animation-delay: calc(var(--stagger-delay) * 4); }

@keyframes bubbleEnter {
  from { opacity: 0; transform: translateX(20px) scale(0.5); }
  to   { opacity: 1; transform: translateX(0) scale(1); }
}

.bubble:hover {
  transform: scale(1.08);
  border-color: var(--bubble-color, var(--color-accent));
  box-shadow: 0 0 8px rgba(255, 208, 0, 0.2);
}
.bubble.active {
  border-color: var(--bubble-color, var(--color-accent));
  box-shadow: 0 0 12px rgba(255, 208, 0, 0.3);
  transform: scale(1.15);
}

.bubble img {
  width: 100%; height: 100%;
  object-fit: cover;
  background: var(--color-surface);
}

.bubble .score-badge {
  position: absolute; bottom: -2px; right: -2px;
  width: 16px; height: 16px; border-radius: 50%;
  font-size: 0.45rem; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  border: 1.5px solid var(--color-bg);
  color: #1A1A2E;
}
.score-badge.good { background: var(--color-green); }
.score-badge.mid  { background: var(--color-yellow); }
.score-badge.bad  { background: var(--color-red); }

/* ══════════════════════════════════════════════════════════
   TIER 2: POPOVER
   ══════════════════════════════════════════════════════════ */
.popover {
  position: fixed;
  z-index: 850;
  width: 280px;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-left: 3px solid var(--color-accent);
  border-radius: 6px;
  padding: 14px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  pointer-events: auto;
  opacity: 0;
  transform: translateX(12px) scale(0.95);
  transition: opacity var(--duration-small) var(--ease-enter),
              transform var(--duration-small) var(--ease-bounce),
              border-color var(--duration-micro);
}
.popover.visible {
  opacity: 1;
  transform: translateX(0) scale(1);
}
.popover.exiting {
  opacity: 0;
  transform: translateX(12px) scale(0.95);
  transition: opacity 100ms var(--ease-exit),
              transform 100ms var(--ease-exit);
}
/* Morph ghost — avatar that "flies" from popover to panel */
.popover.morphing {
  opacity: 0;
  transform: scale(0.8);
  transition: opacity 150ms var(--ease-exit),
              transform 200ms var(--ease-exit);
}

.popover-header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 10px;
}
.popover-avatar {
  width: 36px; height: 36px; border-radius: 50%; overflow: hidden;
  border: 2px solid var(--color-accent); flex-shrink: 0;
  transition: border-color var(--duration-micro);
}
.popover-avatar img { width: 100%; height: 100%; object-fit: cover; }
.popover-name {
  font-size: 0.7rem; font-weight: 700;
  letter-spacing: 0.06em;
  transition: color var(--duration-micro);
}
.popover-role {
  font-size: 0.55rem; color: var(--color-text-dim);
  letter-spacing: 0.04em;
}
.popover-score-wrap {
  margin-left: auto; text-align: center;
}
.popover-score {
  font-size: 1.2rem; font-weight: 800;
  color: var(--color-text);
}
.popover-score small { font-size: 0.55rem; color: var(--color-text-dim); }
.popover-score-bar {
  width: 40px; height: 3px; background: rgba(255,255,255,0.08);
  border-radius: 2px; margin-top: 3px; overflow: hidden;
}
.popover-score-bar .fill {
  height: 100%; border-radius: 2px;
  transition: width var(--duration-small) var(--ease-enter);
}

.popover-short-verdict {
  font-size: 0.65rem; font-weight: 700;
  color: var(--color-text); line-height: 1.5;
  margin-bottom: 10px;
  padding: 6px 8px; background: rgba(255,255,255,0.03);
  border-radius: 3px;
  border-left: 2px solid var(--color-accent);
  transition: border-color var(--duration-micro);
}

.popover-findings {
  display: flex; gap: 4px; flex-wrap: wrap;
  margin-bottom: 10px;
}
.finding-chip {
  font-size: 0.5rem; font-weight: 700;
  padding: 2px 8px; border-radius: 3px;
  text-transform: uppercase; letter-spacing: 0.06em;
  cursor: pointer; position: relative;
  transition: all var(--duration-micro);
}
.finding-chip.green { background: rgba(107,203,119,0.15); color: var(--color-green); }
.finding-chip.yellow { background: rgba(255,217,61,0.15); color: var(--color-yellow); }
.finding-chip.red { background: rgba(255,107,107,0.15); color: var(--color-red); font-weight: 800; }
.finding-chip:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.finding-chip .chip-tooltip {
  position: absolute; bottom: calc(100% + 6px); left: 50%;
  transform: translateX(-50%);
  font-size: 0.45rem; font-weight: 600; text-transform: none;
  letter-spacing: 0.02em; padding: 3px 8px; border-radius: 3px;
  background: var(--color-surface); color: var(--color-text);
  border: 1px solid var(--color-border);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  pointer-events: none; opacity: 0;
  transition: opacity var(--duration-micro);
  max-width: 200px; white-space: normal; text-align: center;
}
.finding-chip:hover .chip-tooltip { opacity: 1; }

.popover-more {
  font-family: var(--font); font-size: 0.55rem; font-weight: 700;
  color: var(--color-accent); background: none; border: none;
  cursor: pointer; letter-spacing: 0.06em;
  padding: 4px 0; transition: all var(--duration-micro);
}
.popover-more:hover { text-decoration: underline; }

/* ══════════════════════════════════════════════════════════
   MORPH GHOST — Flying avatar between popover and panel
   ══════════════════════════════════════════════════════════ */
.morph-ghost {
  position: fixed;
  z-index: 950;
  border-radius: 50%;
  overflow: hidden;
  pointer-events: none;
  transition: all var(--duration-medium) var(--ease-enter);
}
.morph-ghost img {
  width: 100%; height: 100%; object-fit: cover;
}
.morph-ghost.hidden { display: none; }

/* ══════════════════════════════════════════════════════════
   TIER 3: SPLIT PANE PANEL — Page compresses left
   ══════════════════════════════════════════════════════════ */
.review-panel {
  position: fixed;
  top: 28px; right: 0; bottom: 0;
  width: var(--panel-width); max-width: 85vw;
  background: var(--color-bg);
  border-left: 3px solid var(--color-accent);
  z-index: 900;
  overflow-y: auto;
  padding: 20px;

  transform: translateX(100%);
  transition: transform var(--duration-medium) var(--ease-enter),
              border-color var(--duration-micro);
}
.review-panel.open {
  transform: translateX(0);
}
.review-panel.closing {
  transform: translateX(100%);
  transition: transform var(--duration-medium) var(--ease-exit);
}

.panel-header {
  display: flex; align-items: center; gap: 12px;
  margin-bottom: 20px; padding-bottom: 12px;
  border-bottom: 1px solid var(--color-border);
}
.panel-avatar {
  width: 48px; height: 48px; border-radius: 50%; overflow: hidden;
  border: 2px solid var(--color-accent); flex-shrink: 0;
  transition: border-color var(--duration-micro);
}
.panel-avatar img { width: 100%; height: 100%; object-fit: cover; }
.panel-name {
  font-size: 0.85rem; font-weight: 700;
  letter-spacing: 0.06em;
  transition: color var(--duration-micro);
}
.panel-role { font-size: 0.6rem; color: var(--color-text-dim); }
.panel-score-ring {
  margin-left: auto;
  width: 44px; height: 44px;
  border-radius: 50%;
  border: 3px solid var(--color-accent);
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; font-weight: 800;
  transition: border-color var(--duration-micro);
}
.panel-close {
  position: absolute; top: 12px; right: 12px;
  font-family: var(--font); font-size: 0.8rem;
  background: none; border: none; color: var(--color-text-dim);
  cursor: pointer; width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%;
  transition: all var(--duration-micro);
}
.panel-close:hover { color: var(--color-accent); background: rgba(255,208,0,0.1); }

.panel-verdict {
  font-size: 0.7rem; font-style: italic; color: var(--color-text-dim);
  line-height: 1.7; margin-bottom: 20px; padding: 12px;
  background: rgba(255,255,255,0.03); border-radius: 4px;
  border-left: 3px solid var(--color-accent);
  transition: border-color var(--duration-micro);
}

.severity-summary {
  display: flex; gap: 12px; margin-bottom: 16px;
  padding: 8px 12px; background: rgba(255,255,255,0.02);
  border-radius: 4px; font-size: 0.55rem; font-weight: 700;
  letter-spacing: 0.06em;
}
.severity-summary .sev-item {
  display: flex; align-items: center; gap: 4px;
}
.severity-summary .sev-dot {
  width: 8px; height: 8px; border-radius: 50%;
}
.severity-summary .sev-dot.red { background: var(--color-red); }
.severity-summary .sev-dot.yellow { background: var(--color-yellow); }
.severity-summary .sev-dot.green { background: var(--color-green); }

.panel-section {
  margin-bottom: 16px;
  opacity: 0;
  animation: panelSectionEnter var(--duration-small) var(--ease-enter) forwards;
}
.panel-section:nth-child(1) { animation-delay: calc(var(--stagger-delay) * 1); }
.panel-section:nth-child(2) { animation-delay: calc(var(--stagger-delay) * 2); }
.panel-section:nth-child(3) { animation-delay: calc(var(--stagger-delay) * 3); }
.panel-section:nth-child(4) { animation-delay: calc(var(--stagger-delay) * 4); }
.panel-section:nth-child(5) { animation-delay: calc(var(--stagger-delay) * 5); }
.panel-section:nth-child(6) { animation-delay: calc(var(--stagger-delay) * 6); }

@keyframes panelSectionEnter {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

.panel-section-label {
  font-size: 0.55rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.12em; margin-bottom: 8px; padding-bottom: 4px;
  border-bottom: 1px solid var(--color-border);
  transition: color var(--duration-micro);
}

.panel-finding {
  display: flex; gap: 8px; align-items: flex-start;
  padding: 8px 0; font-size: 0.65rem; line-height: 1.6;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  cursor: default;
  transition: background var(--duration-micro);
}
.panel-finding:hover {
  background: rgba(255,208,0,0.03);
}
.panel-finding .light {
  width: 8px; height: 8px; border-radius: 50%;
  flex-shrink: 0; margin-top: 5px;
}
.panel-finding .light.green  { background: var(--color-green); }
.panel-finding .light.yellow { background: var(--color-yellow); }
.panel-finding .light.red    { background: var(--color-red); }
.panel-finding.severity-red .finding-text {
  font-weight: 700; color: var(--color-text);
}
.panel-finding.severity-yellow .finding-text {
  color: var(--color-text);
}
.panel-finding.severity-green .finding-text {
  color: var(--color-text-dim);
}
.panel-finding .comment {
  font-size: 0.6rem; color: var(--color-text-dim);
  font-style: italic; margin-top: 4px;
}

/* ── Dock Chin ─────────────────────────────────────────── */
.dock-chin {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 900;
  height: 56px;
  display: flex; align-items: center; justify-content: center;
  background: var(--color-bg);
  border-left: 8px solid var(--color-bg);
  border-right: 8px solid var(--color-bg);
  border-bottom: 8px solid var(--color-bg);
  border-radius: 0 0 10px 10px;
  box-shadow: inset 0 3px 8px rgba(0,0,0,0.06);
}

/* ── CRT Bezel ─────────────────────────────────────────── */
body::after {
  content: '';
  position: fixed; inset: 0;
  border: 8px solid var(--color-bg);
  border-bottom: none;
  pointer-events: none;
  z-index: 99999;
  border-radius: 10px 10px 0 0;
  box-shadow: inset 0 0 30px rgba(0,0,0,0.25);
}

/* ── Accessibility ─────────────────────────────────────── */
*:focus-visible {
  outline: 2px solid var(--color-accent);
  outline-offset: 2px;
}

/* ── Scrollbar ─────────────────────────────────────────── */
.review-panel::-webkit-scrollbar { width: 5px; }
.review-panel::-webkit-scrollbar-track { background: transparent; }
.review-panel::-webkit-scrollbar-thumb { background: var(--color-accent); border-radius: 3px; }
</style>
</head>
<body>

<!-- Info Banner -->
<div class="info-banner">
  PREVIEW T1: SPLIT PANE + MORPH &mdash;
  Click bubbles. Panel opens alongside content (split pane). Avatar morphs between tiers.
</div>

<!-- Tier Controls -->
<div class="controls">
  <button class="active" onclick="showTier('rail')">Tier 1: Rail</button>
  <button onclick="showTier('popover')">Tier 2: Popover</button>
  <button onclick="showTier('panel')">Tier 3: Split Pane</button>
  <button onclick="resetAll()">Reset</button>
</div>

<!-- ═══ Mock Page Content ═══ -->
<div class="mock-page" id="mockPage">
  <h1>Stop Shipping<br>AI Slop.</h1>
  <p class="subtitle">
    Unlock the power of next-generation AI to streamline your processes,
    boost productivity, and transform the way your team collaborates.
  </p>

  <div class="mock-section" data-section="hero">
    <div class="section-label">Hero</div>
    <p>
      Every AI page looks the same. Same gradients, same stock illustrations,
      same "Unlock the power of..." copy. This is a landing page hero section
      that we'll highlight when hovering over findings.
    </p>
    <div class="section-annotation"></div>
  </div>

  <div class="mock-section" data-section="features">
    <div class="section-label">Features</div>
    <p>
      Feature cards with icons, three-column grid, subtle shadows. You've seen
      this pattern on every SaaS marketing page since 2019.
    </p>
    <div class="section-annotation"></div>
  </div>

  <div class="mock-section" data-section="pricing">
    <div class="section-label">Pricing</div>
    <p>
      Three tiers: Free, Pro, Enterprise. The middle one is highlighted because
      that's what everyone does. "Start Free" implies a non-existent free tier.
    </p>
    <div class="section-annotation"></div>
  </div>

  <div class="mock-section" data-section="testimonials">
    <div class="section-label">Testimonials</div>
    <p>
      "This product changed our workflow completely!" — Generic Person, Generic Company.
    </p>
    <div class="section-annotation"></div>
  </div>
</div>

<!-- ═══ TIER 1: Bubble Rail ═══ -->
<div class="bubble-rail" id="bubbleRail">
  <div class="aggregate-summary" id="aggregateSummary"></div>
  <div class="mode-toggle">
    <button class="active" onclick="switchMode('experts')">REVIEW</button>
    <button onclick="switchMode('personas')">KAIZEN</button>
  </div>
  <div id="expertBubbles"></div>
  <div class="rail-divider" id="railDivider" style="display:none;"></div>
  <div id="personaBubbles" style="display:none; flex-direction:column; gap:6px;"></div>
</div>

<!-- ═══ TIER 2: Popover ═══ -->
<div class="popover" id="popover">
  <div class="popover-header">
    <div class="popover-avatar" id="popAvatarWrap">
      <img id="popAvatar" src="" alt="" />
    </div>
    <div>
      <div class="popover-name" id="popName"></div>
      <div class="popover-role" id="popRole"></div>
    </div>
    <div class="popover-score-wrap">
      <div class="popover-score" id="popScore"></div>
      <div class="popover-score-bar"><div class="fill" id="popScoreBar"></div></div>
    </div>
  </div>
  <div class="popover-short-verdict" id="popShortVerdict"></div>
  <div class="popover-findings" id="popFindings"></div>
  <button class="popover-more" onclick="openPanel()">VIEW FULL REVIEW &rarr;</button>
</div>

<!-- Morph Ghost (flying avatar) -->
<div class="morph-ghost hidden" id="morphGhost">
  <img id="morphGhostImg" src="" alt="" />
</div>

<!-- ═══ TIER 3: Split Pane Panel ═══ -->
<div class="review-panel" id="reviewPanel">
  <button class="panel-close" onclick="closePanel()">&times;</button>
  <div class="panel-header">
    <div class="panel-avatar" id="panelAvatarWrap">
      <img id="panelAvatar" src="" alt="" />
    </div>
    <div>
      <div class="panel-name" id="panelName"></div>
      <div class="panel-role" id="panelRole"></div>
    </div>
    <div class="panel-score-ring" id="panelScore"></div>
  </div>
  <div class="panel-verdict" id="panelVerdict"></div>
  <div class="severity-summary" id="severitySummary"></div>
  <div class="panel-sections" id="panelSections"></div>
</div>

<!-- Dock Chin -->
<div class="dock-chin"></div>

<script>
// ── State ──────────────────────────────────────────────
let activeBubble = null;
let currentTier = 'rail';
let currentMode = 'experts';
let isClosing = false;
let isMorphing = false;

// ── Expert Data — Distinct Voices ──────────────────────
const experts = {
  marketing: {
    name: 'MARKETING', role: 'Positioning \u00b7 Messaging \u00b7 CTA', score: 6,
    color: '#FF6B6B',
    avatar: 'https://api.dicebear.com/9.x/shapes/svg?seed=marketing-expert&backgroundColor=FF6B6B',
    shortVerdict: 'Strong hook, weak follow-through.',
    verdict: "Your visitor sees \u201cAI-powered\u201d and bounces \u2014 they\u2019ve read that 47 times today. The \u201cStop Shipping AI Slop\u201d tagline? That\u2019s gold. But the features section sounds like every SaaS page they\u2019ve ever closed.",
    findings: {
      hero: [
        { light: 'green', text: '\u201cStop Shipping AI Slop\u201d is differentiated and memorable', comment: 'This is your best asset. Make it unmissable.' },
        { light: 'yellow', text: 'No social proof above the fold', comment: 'No logos, no numbers. Why should they trust you?' }
      ],
      features: [
        { light: 'red', text: '\u201cNext-generation AI\u201d \u2014 verbal clip art', comment: 'Every competitor says this. What do you actually do differently?' },
        { light: 'yellow', text: 'Three identical cards, zero hierarchy', comment: 'Three equal options = three things they\u2019ll skip equally.' }
      ],
      pricing: [
        { light: 'red', text: '\u201cStart Free\u201d promises a tier that doesn\u2019t exist', comment: 'Misleading CTAs don\u2019t just lose clicks \u2014 they nuke credibility.' }
      ],
      testimonials: [
        { light: 'yellow', text: '\u201cChanged our workflow\u201d says nothing', comment: 'Show numbers: \u201cCut review time from 3 days to 4 hours.\u201d' }
      ]
    }
  },
  ux: {
    name: 'UX', role: 'Usability \u00b7 Flow \u00b7 Accessibility', score: 8,
    color: '#4ECDC4',
    avatar: 'https://api.dicebear.com/9.x/shapes/svg?seed=ux-expert&backgroundColor=4ECDC4',
    shortVerdict: 'Clean hierarchy, minor friction.',
    verdict: "Try to find the pricing \u2014 one scroll, good. Try to understand what this tool does from the features section. That\u2019s where it breaks. Jargon-heavy labels, no progressive disclosure.",
    findings: {
      hero: [
        { light: 'green', text: 'Clear visual hierarchy, scannable in under 3 seconds', comment: 'Eye tracks headline \u2192 subtitle \u2192 CTA naturally.' },
        { light: 'green', text: 'Good contrast ratios on heading text', comment: 'Passes WCAG AA. Keep it.' }
      ],
      features: [
        { light: 'yellow', text: 'Feature labels use internal jargon', comment: 'Try reading these aloud to a non-technical friend. Watch them squint.' },
        { light: 'yellow', text: 'No progressive disclosure on feature details', comment: 'All detail visible at once. Let users expand what interests them.' }
      ],
      pricing: [
        { light: 'green', text: 'Pricing tiers are easy to compare', comment: 'Clean comparison layout. Users can decide quickly.' }
      ],
      testimonials: [
        { light: 'green', text: 'Testimonial section is scannable', comment: 'Quote + attribution format works. Content could be stronger.' }
      ]
    }
  },
  product: {
    name: 'PRODUCT', role: 'Features \u00b7 Differentiation \u00b7 Value', score: 5,
    color: '#FFD93D',
    avatar: 'https://api.dicebear.com/9.x/shapes/svg?seed=product-expert&backgroundColor=FFD93D',
    shortVerdict: 'No unique value proposition.',
    verdict: "Every competitor claims \u201cAI-powered insights.\u201d Jasper does it. Copy.ai does it. What do you do that none of them can? I can\u2019t answer that from this page.",
    findings: {
      hero: [
        { light: 'green', text: 'Anti-slop positioning is genuinely unique', comment: 'Nobody else attacks the \u201cAI sameness\u201d problem. Own this.' }
      ],
      features: [
        { light: 'red', text: 'Feature list is undifferentiated', comment: 'Remove anything a competitor also offers. Show only what\u2019s yours.' },
        { light: 'red', text: 'No competitive framing anywhere', comment: 'Unlike [X], SLAP does [Y]. Without this, you\u2019re just another entry.' }
      ],
      pricing: [
        { light: 'yellow', text: 'Tier names tell me nothing about who it\u2019s for', comment: 'Standard pattern. \u201cPro\u201d vs \u201cEnterprise\u201d \u2014 who am I?' }
      ],
      testimonials: [
        { light: 'red', text: 'No case study or measurable outcome', comment: '\u201cChanged our workflow\u201d could be said about a new coffee machine.' }
      ]
    }
  },
  technical: {
    name: 'TECHNICAL', role: 'Performance \u00b7 Architecture \u00b7 Scale', score: 7,
    color: '#95E1D3',
    avatar: 'https://api.dicebear.com/9.x/shapes/svg?seed=technical-expert&backgroundColor=95E1D3',
    shortVerdict: 'Solid markup, missing optimizations.',
    verdict: "LCP estimate: 2.4s. Above-fold images: 3, lazy-loaded: 0. No preconnect hints for external fonts. CLS risk from dynamic testimonial content.",
    findings: {
      hero: [
        { light: 'green', text: 'Semantic HTML structure is correct', comment: 'h1 \u2192 p \u2192 section hierarchy. Screen readers parse this fine.' }
      ],
      features: [
        { light: 'green', text: 'CSS grid layout, not absolute positioning', comment: 'Responsive without breakpoint hacks. Clean.' },
        { light: 'yellow', text: 'No lazy-loading on below-fold images', comment: 'Add loading="lazy" to anything outside initial viewport.' }
      ],
      pricing: [
        { light: 'yellow', text: 'Dynamic pricing toggle may cause CLS', comment: 'Reserve height for monthly/annual toggle content.' }
      ],
      testimonials: [
        { light: 'green', text: 'Testimonial images are appropriately sized', comment: 'No 2000px images rendered at 48px. Good.' }
      ]
    }
  },
  design: {
    name: 'DESIGN', role: 'Visual \u00b7 Branding \u00b7 Aesthetics', score: 6,
    color: '#F38181',
    avatar: 'https://api.dicebear.com/9.x/shapes/svg?seed=design-expert&backgroundColor=F38181',
    shortVerdict: 'Cohesive palette, feels templated.',
    verdict: "The spacing reads as template \u2014 nothing breathes, nothing surprises. Color palette is cohesive but safe. Where\u2019s the moment that makes someone screenshot this and share it?",
    findings: {
      hero: [
        { light: 'yellow', text: 'Typography hierarchy needs more contrast', comment: 'The jump from h1 to body text is too gentle. Make the headline shout.' },
        { light: 'green', text: 'Color palette is internally consistent', comment: 'Accent, text, and background work together. No clashing.' }
      ],
      features: [
        { light: 'yellow', text: 'Card styling looks like a Tailwind template', comment: 'Same radius, same shadow, same padding. Where\u2019s the personality?' },
        { light: 'yellow', text: 'Icon style doesn\u2019t match brand voice', comment: 'Generic line icons on a page that says \u201cstop being generic.\u201d' }
      ],
      pricing: [
        { light: 'green', text: 'Highlighted tier has clear visual emphasis', comment: 'Good use of accent color and scale to signal recommended.' }
      ],
      testimonials: [
        { light: 'yellow', text: 'Quote styling is indistinguishable from body text', comment: 'Testimonials should feel different \u2014 larger, italic, or boxed.' }
      ]
    }
  }
};

const personas = {
  marcus: {
    name: 'MARCUS', role: 'Colorblind Developer \u00b7 Accessibility', score: 7,
    color: '#4ECDC4',
    avatar: 'https://api.dicebear.com/9.x/adventurer/svg?seed=marcus&backgroundColor=4ECDC4',
    shortVerdict: 'High contrast good, links invisible.',
    verdict: "Dark background with light text? Great start. But those gray placeholder links? Invisible to me. And the green/red score badges \u2014 I literally cannot tell them apart. Use shapes, not just color.",
    findings: {
      hero: [
        { light: 'green', text: 'High contrast ratios on primary content', comment: 'I can read everything above the fold. That\u2019s sadly rare.' }
      ],
      features: [
        { light: 'yellow', text: 'Hover states rely only on color change', comment: 'Add an underline or border shift. Color alone fails for 8% of men.' }
      ],
      pricing: [
        { light: 'green', text: 'Comparison doesn\u2019t depend on color coding', comment: 'Structure communicates the difference, not just color.' }
      ],
      testimonials: [
        { light: 'yellow', text: 'Attribution links are low-contrast gray', comment: 'I can\u2019t see these. Bump contrast or add underlines.' }
      ]
    }
  },
  dorothy: {
    name: 'DOROTHY', role: 'Non-Technical User \u00b7 Tech Spectrum', score: 5,
    color: '#6BCB77',
    avatar: 'https://api.dicebear.com/9.x/adventurer/svg?seed=dorothy&backgroundColor=6BCB77',
    shortVerdict: 'What does this thing actually do?',
    verdict: "I read the whole page. I still don\u2019t know what this product does. \u201cStreamline your processes\u201d \u2014 what processes? \u201cAI-powered insights\u201d \u2014 insights about what?",
    findings: {
      hero: [
        { light: 'yellow', text: '\u201cStop Shipping AI Slop\u201d \u2014 catchy but confusing', comment: 'I don\u2019t know what \u201cAI slop\u201d means. Am I supposed to?' }
      ],
      features: [
        { light: 'red', text: 'Every feature description uses jargon', comment: '\u201cStreamline your processes\u201d \u2014 what processes? Be specific.' },
        { light: 'red', text: 'No screenshots showing the actual product', comment: 'Show me what it looks like. I can\u2019t evaluate words alone.' }
      ],
      pricing: [
        { light: 'yellow', text: 'Tier names don\u2019t tell me which one I need', comment: 'Am I \u201cPro\u201d? Just say: \u201cFor individuals\u201d vs \u201cFor teams.\u201d' }
      ],
      testimonials: [
        { light: 'green', text: 'Real person names make it feel trustworthy', comment: 'Even if the quote is generic, the name + company helps.' }
      ]
    }
  },
  carlos: {
    name: 'CARLOS', role: 'CEO \u00b7 Decision Maker', score: 4,
    color: '#FFD93D',
    avatar: 'https://api.dicebear.com/9.x/adventurer/svg?seed=carlos&backgroundColor=FFD93D',
    shortVerdict: 'No ROI, no case studies, no deal.',
    verdict: "I have 45 seconds between meetings. Show me: what does it cost, what does it save, who else uses it. This page has none of that. I\u2019m closing the tab.",
    findings: {
      hero: [
        { light: 'yellow', text: 'Tagline is clever but doesn\u2019t communicate value', comment: 'I need \u201csaves X hours\u201d or \u201creduces Y costs,\u201d not a joke.' }
      ],
      features: [
        { light: 'red', text: 'No ROI metrics anywhere on the page', comment: 'How much time does this save? How much money? Give me a number.' },
        { light: 'red', text: 'No enterprise logos or case studies', comment: 'If no recognizable company uses this, I\u2019m not the first to try.' }
      ],
      pricing: [
        { light: 'red', text: 'No annual billing discount visible', comment: 'I budget annually. No discount = not enterprise-ready.' }
      ],
      testimonials: [
        { light: 'red', text: '\u201cGeneric Company\u201d \u2014 literally says generic', comment: 'This is placeholder content. Ship when you have real logos.' }
      ]
    }
  },
  frank: {
    name: 'FRANK', role: 'Skeptical Evaluator \u00b7 Emotional State', score: 3,
    color: '#FF6B6B',
    avatar: 'https://api.dicebear.com/9.x/adventurer/svg?seed=frank&backgroundColor=FF6B6B',
    shortVerdict: 'Heard this pitch 47 times.',
    verdict: "Another AI tool that \u201ctransforms the way you collaborate.\u201d I\u2019ve heard this pitch 47 times this quarter. The anti-slop angle is interesting but the page commits every sin it claims to fight.",
    findings: {
      hero: [
        { light: 'red', text: 'Page about fighting AI slop... is AI slop', comment: 'The irony is not endearing. It\u2019s disqualifying.' },
        { light: 'yellow', text: '\u201cUnlock the power of next-generation AI\u201d', comment: 'Did you seriously put this on a page called \u201cStop Shipping AI Slop\u201d?' }
      ],
      features: [
        { light: 'red', text: 'Every bullet is a buzzword bingo winner', comment: '\u201cBoost productivity\u201d \u2014 I\u2019d bet money an AI wrote this copy.' },
        { light: 'red', text: 'No demo, no proof, no substance', comment: 'Claims without evidence. I\u2019ve been burned. Next.' }
      ],
      pricing: [
        { light: 'yellow', text: 'Three-tier pricing without justification', comment: 'Why these tiers? Looks auto-generated.' }
      ],
      testimonials: [
        { light: 'red', text: 'Fake-looking testimonials nuke credibility', comment: '\u201cGeneric Person, Generic Company\u201d \u2014 you couldn\u2019t even fake it well.' }
      ]
    }
  },
  sam: {
    name: 'SAM', role: 'Mobile-First User \u00b7 Context', score: 6,
    color: '#9B59B6',
    avatar: 'https://api.dicebear.com/9.x/adventurer/svg?seed=sam&backgroundColor=9B59B6',
    shortVerdict: 'Desktop fine, pricing breaks on mobile.',
    verdict: "Scrolling on my phone. Hero looks great \u2014 text scales well. Feature cards stack cleanly. But pricing? Three side-by-side cards become three full-screen scrolls. I lose the ability to compare.",
    findings: {
      hero: [
        { light: 'green', text: 'Responsive text scaling works well', comment: 'clamp() on headings \u2014 adapts without breakpoint jumps.' },
        { light: 'green', text: 'No horizontal overflow on small screens', comment: 'Tested at 320px. Nothing breaks.' }
      ],
      features: [
        { light: 'green', text: 'Feature cards stack vertically on mobile', comment: 'Clean single-column layout. Each card digestible.' }
      ],
      pricing: [
        { light: 'yellow', text: 'Pricing cards stack awkwardly on mobile', comment: 'Stacked = can\u2019t compare. Consider a toggle or table view.' },
        { light: 'yellow', text: 'No sticky header on mobile', comment: 'Once past the hero, no way to navigate except scrolling back.' }
      ],
      testimonials: [
        { light: 'yellow', text: 'Carousel dots too small for touch targets', comment: 'Minimum 44x44px tap targets. Those dots are about 12px.' }
      ]
    }
  }
};

// ── Helpers ────────────────────────────────────────────
function scoreClass(score) {
  if (score >= 7) return 'good';
  if (score >= 5) return 'mid';
  return 'bad';
}

function countSeverity(findings) {
  const counts = { red: 0, yellow: 0, green: 0 };
  for (const section of Object.values(findings)) {
    for (const f of section) counts[f.light]++;
  }
  return counts;
}

function firstFindingText(sectionFindings) {
  if (!sectionFindings || sectionFindings.length === 0) return '';
  return sectionFindings[0].text;
}

function getAnnotation(sectionFindings) {
  if (!sectionFindings || sectionFindings.length === 0) return '';
  const worst = sectionFindings.find(f => f.light === 'red')
    || sectionFindings.find(f => f.light === 'yellow')
    || sectionFindings[0];
  let t = worst.text;
  if (t.length > 45) t = t.substring(0, 42) + '...';
  return t;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ── Render Bubbles ────────────────────────────────────
function renderBubbles() {
  const expertContainer = document.getElementById('expertBubbles');
  const personaContainer = document.getElementById('personaBubbles');
  expertContainer.innerHTML = '';
  personaContainer.innerHTML = '';
  expertContainer.style.display = 'flex';
  expertContainer.style.flexDirection = 'column';
  expertContainer.style.gap = '6px';

  Object.entries(experts).forEach(([id, d], i) => {
    expertContainer.appendChild(createBubble(id, d, i));
  });
  Object.entries(personas).forEach(([id, d], i) => {
    personaContainer.appendChild(createBubble(id, d, i));
  });
  updateAggregate();
}

function createBubble(id, data, index) {
  const div = document.createElement('div');
  div.className = 'bubble';
  div.dataset.id = id;
  div.title = data.name + ' \u2014 ' + data.shortVerdict;
  div.style.setProperty('--bubble-color', data.color);
  div.style.animationDelay = (index * 60) + 'ms';
  div.onclick = function() { onBubbleClick(this); };
  div.innerHTML = `
    <img src="${data.avatar}" alt="${data.name}" loading="lazy" />
    <div class="score-badge ${scoreClass(data.score)}">${data.score}</div>
  `;
  return div;
}

// ── Aggregate ─────────────────────────────────────────
function updateAggregate() {
  const data = currentMode === 'experts' ? experts : personas;
  const entries = Object.values(data);
  const avgScore = (entries.reduce((s, e) => s + e.score, 0) / entries.length).toFixed(1);
  let totalRed = 0, totalYellow = 0, totalGreen = 0;
  entries.forEach(e => {
    const c = countSeverity(e.findings);
    totalRed += c.red; totalYellow += c.yellow; totalGreen += c.green;
  });
  const el = document.getElementById('aggregateSummary');
  el.innerHTML = `
    <div class="aggregate-score">${avgScore}<small>/10</small></div>
    <div class="aggregate-lights">
      ${Array(Math.min(totalRed, 6)).fill('<div class="dot red"></div>').join('')}
      ${Array(Math.min(totalYellow, 6)).fill('<div class="dot yellow"></div>').join('')}
      ${Array(Math.min(totalGreen, 6)).fill('<div class="dot green"></div>').join('')}
    </div>
  `;
  el.classList.toggle('hidden', !!activeBubble);
}

// ── Bubble Click ───────────────────────────────────────
function onBubbleClick(el) {
  if (isMorphing) return;
  const id = el.dataset.id;
  const data = currentMode === 'experts' ? experts[id] : personas[id];
  if (!data) return;

  document.querySelectorAll('.bubble.active').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  activeBubble = { el, id, data };
  updateAggregate();

  document.documentElement.style.setProperty('--highlight-color', data.color);

  // Position popover with boundary detection
  const rect = el.getBoundingClientRect();
  const pop = document.getElementById('popover');
  const popHeight = 260;
  let topPos = rect.top;
  if (topPos + popHeight > window.innerHeight - 20) {
    topPos = Math.max(40, window.innerHeight - popHeight - 20);
  }
  pop.style.top = topPos + 'px';
  pop.style.right = (window.innerWidth - rect.left + 8) + 'px';

  // Apply expert color
  pop.style.borderLeftColor = data.color;
  document.getElementById('popAvatar').src = data.avatar;
  document.getElementById('popAvatarWrap').style.borderColor = data.color;
  const nameEl = document.getElementById('popName');
  nameEl.textContent = data.name;
  nameEl.style.color = data.color;
  document.getElementById('popRole').textContent = data.role;
  document.getElementById('popScore').innerHTML = data.score + '<small>/10</small>';

  const bar = document.getElementById('popScoreBar');
  bar.style.width = (data.score * 10) + '%';
  bar.style.background = data.color;

  const svEl = document.getElementById('popShortVerdict');
  svEl.textContent = data.shortVerdict;
  svEl.style.borderLeftColor = data.color;

  // Finding chips
  const chipsEl = document.getElementById('popFindings');
  chipsEl.innerHTML = '';
  for (const [section, sectionFindings] of Object.entries(data.findings)) {
    const worst = sectionFindings.find(f => f.light === 'red')
      || sectionFindings.find(f => f.light === 'yellow')
      || sectionFindings[0];
    const chip = document.createElement('span');
    chip.className = 'finding-chip ' + worst.light;
    const icon = worst.light === 'green' ? '\u2713' : worst.light === 'red' ? '\u2717' : '~';
    chip.innerHTML = section.charAt(0).toUpperCase() + section.slice(1) + ' ' + icon
      + '<span class="chip-tooltip">' + escapeHtml(firstFindingText(sectionFindings)) + '</span>';
    chip.onmouseenter = () => highlightSection(section, data);
    chip.onmouseleave = () => highlightSection(null);
    chipsEl.appendChild(chip);
  }

  pop.classList.remove('exiting', 'morphing');
  pop.classList.add('visible');
  document.getElementById('mockPage').classList.add('dimmed');
  showTier('popover');
}

// ── Section Highlight ─────────────────────────────────
function highlightSection(key, expertData) {
  document.querySelectorAll('.mock-section').forEach(s => {
    s.classList.remove('highlighted');
    const ann = s.querySelector('.section-annotation');
    if (ann) ann.textContent = '';
  });
  if (key && expertData) {
    const el = document.querySelector(`.mock-section[data-section="${key}"]`);
    if (el) {
      el.classList.add('highlighted');
      const ann = el.querySelector('.section-annotation');
      if (ann) ann.textContent = getAnnotation(expertData.findings[key]);
    }
  }
}

// ── MORPH: Popover → Panel ────────────────────────────
function openPanel() {
  if (!activeBubble || isMorphing) return;
  isMorphing = true;
  const d = activeBubble.data;
  const pop = document.getElementById('popover');
  const panel = document.getElementById('reviewPanel');
  const mockPage = document.getElementById('mockPage');
  const rail = document.getElementById('bubbleRail');

  // STEP 1: Capture popover avatar position (First)
  const popAvatarEl = document.getElementById('popAvatarWrap');
  const firstRect = popAvatarEl.getBoundingClientRect();

  // STEP 2: Prepare panel content (before showing)
  fillPanel(d);

  // STEP 3: Morph ghost — create flying avatar
  const ghost = document.getElementById('morphGhost');
  const ghostImg = document.getElementById('morphGhostImg');
  ghostImg.src = d.avatar;
  ghost.classList.remove('hidden');
  ghost.style.width = firstRect.width + 'px';
  ghost.style.height = firstRect.height + 'px';
  ghost.style.left = firstRect.left + 'px';
  ghost.style.top = firstRect.top + 'px';
  ghost.style.border = '2px solid ' + d.color;
  ghost.style.transition = 'none';

  // STEP 4: Fade popover (morph out)
  pop.classList.add('morphing');

  // STEP 5: After popover fades, open panel + compress page + move ghost
  setTimeout(() => {
    pop.classList.remove('visible', 'morphing');

    // Open panel (split pane)
    panel.classList.remove('closing');
    panel.classList.add('open');

    // Compress page left
    mockPage.classList.remove('dimmed');
    mockPage.classList.add('compressed');

    // Shift rail
    rail.classList.add('shifted');

    // STEP 6: After panel is partially visible, fly ghost to panel avatar position
    requestAnimationFrame(() => {
      const panelAvatarEl = document.getElementById('panelAvatarWrap');
      const lastRect = panelAvatarEl.getBoundingClientRect();

      ghost.style.transition = `all var(--duration-medium) var(--ease-enter)`;
      ghost.style.left = lastRect.left + 'px';
      ghost.style.top = lastRect.top + 'px';
      ghost.style.width = lastRect.width + 'px';
      ghost.style.height = lastRect.height + 'px';
    });

    // STEP 7: After morph completes, hide ghost
    setTimeout(() => {
      ghost.classList.add('hidden');
      isMorphing = false;
    }, 450);

    showTier('panel');
  }, 180);
}

function fillPanel(d) {
  document.getElementById('panelAvatar').src = d.avatar;
  document.getElementById('panelAvatarWrap').style.borderColor = d.color;
  const nameEl = document.getElementById('panelName');
  nameEl.textContent = d.name;
  nameEl.style.color = d.color;
  document.getElementById('panelRole').textContent = d.role;
  const scoreRing = document.getElementById('panelScore');
  scoreRing.textContent = d.score;
  scoreRing.style.borderColor = d.color;

  const verdictEl = document.getElementById('panelVerdict');
  verdictEl.textContent = d.verdict;
  verdictEl.style.borderLeftColor = d.color;

  document.getElementById('reviewPanel').style.borderLeftColor = d.color;

  // Severity summary
  const counts = countSeverity(d.findings);
  document.getElementById('severitySummary').innerHTML = `
    <div class="sev-item"><div class="sev-dot red"></div>${counts.red} critical</div>
    <div class="sev-item"><div class="sev-dot yellow"></div>${counts.yellow} warnings</div>
    <div class="sev-item"><div class="sev-dot green"></div>${counts.green} passing</div>
  `;

  // Severity-sorted findings
  const sectionsEl = document.getElementById('panelSections');
  sectionsEl.innerHTML = '';

  const allFindings = [];
  for (const [section, sectionFindings] of Object.entries(d.findings)) {
    for (const f of sectionFindings) allFindings.push({ section, ...f });
  }
  const severityOrder = { red: 0, yellow: 1, green: 2 };
  allFindings.sort((a, b) => severityOrder[a.light] - severityOrder[b.light]);

  const groups = { red: [], yellow: [], green: [] };
  allFindings.forEach(f => groups[f.light].push(f));
  const groupLabels = { red: 'Critical Issues', yellow: 'Warnings', green: 'Passing' };

  let sectionIndex = 0;
  for (const [severity, findings] of Object.entries(groups)) {
    if (findings.length === 0) continue;
    const section = document.createElement('div');
    section.className = 'panel-section';
    section.style.animationDelay = (sectionIndex * 60) + 'ms';

    const label = document.createElement('div');
    label.className = 'panel-section-label';
    label.style.color = severity === 'red' ? 'var(--color-red)' :
                        severity === 'yellow' ? 'var(--color-yellow)' : 'var(--color-green)';
    label.textContent = groupLabels[severity] + ' (' + findings.length + ')';
    section.appendChild(label);

    findings.forEach(f => {
      const finding = document.createElement('div');
      finding.className = 'panel-finding severity-' + f.light;
      finding.onmouseenter = () => highlightSection(f.section, activeBubble.data);
      finding.onmouseleave = () => highlightSection(null);
      finding.innerHTML = `
        <div class="light ${f.light}"></div>
        <div>
          <div class="finding-text">${escapeHtml(f.text)}</div>
          <div class="comment">${escapeHtml(f.comment)}</div>
          <div style="font-size:0.45rem;color:var(--color-text-dim);margin-top:2px;text-transform:uppercase;letter-spacing:0.08em;">${f.section}</div>
        </div>
      `;
      section.appendChild(finding);
    });

    sectionsEl.appendChild(section);
    sectionIndex++;
  }

  // Re-trigger stagger
  sectionsEl.querySelectorAll('.panel-section').forEach(s => {
    s.style.animation = 'none';
    s.offsetHeight;
    s.style.animation = '';
  });
}

// ── Close Panel — Reverse choreography ────────────────
function closePanel() {
  if (isClosing) return;
  isClosing = true;

  const panel = document.getElementById('reviewPanel');
  const mockPage = document.getElementById('mockPage');
  const rail = document.getElementById('bubbleRail');

  // Step 1: Panel slides out
  panel.classList.add('closing');
  panel.classList.remove('open');

  // Step 2: Page decompresses (slightly delayed)
  setTimeout(() => {
    mockPage.classList.remove('compressed');
    mockPage.classList.remove('dimmed');
    rail.classList.remove('shifted');
  }, 100);

  // Step 3: Clean up after animation completes
  setTimeout(() => {
    panel.classList.remove('closing');
    document.getElementById('popover').classList.remove('visible', 'exiting', 'morphing');
    document.querySelectorAll('.bubble.active').forEach(b => b.classList.remove('active'));
    highlightSection(null);
    activeBubble = null;
    updateAggregate();
    showTier('rail');
    isClosing = false;
  }, 450);
}

// ── Mode Switch ────────────────────────────────────────
function switchMode(mode) {
  currentMode = mode;
  if (activeBubble) {
    document.querySelectorAll('.bubble.active').forEach(b => b.classList.remove('active'));
    document.getElementById('popover').classList.remove('visible');
    document.getElementById('reviewPanel').classList.remove('open');
    document.getElementById('mockPage').classList.remove('dimmed', 'compressed');
    document.getElementById('bubbleRail').classList.remove('shifted');
    highlightSection(null);
    activeBubble = null;
  }

  const toggleBtns = document.querySelectorAll('.mode-toggle button');
  toggleBtns.forEach(b => b.classList.remove('active'));
  if (mode === 'experts') toggleBtns[0].classList.add('active');
  else toggleBtns[1].classList.add('active');

  const expertEl = document.getElementById('expertBubbles');
  const personaEl = document.getElementById('personaBubbles');

  if (mode === 'experts') {
    expertEl.style.display = 'flex';
    personaEl.style.display = 'none';
  } else {
    expertEl.style.display = 'none';
    personaEl.style.display = 'flex';
  }

  const container = mode === 'experts' ? expertEl : personaEl;
  container.querySelectorAll('.bubble').forEach((b, i) => {
    b.style.animation = 'none';
    b.offsetHeight;
    b.style.animation = `bubbleEnter var(--duration-medium) var(--ease-enter) ${i * 60}ms forwards`;
  });

  updateAggregate();
  showTier('rail');
}

// ── Tier Controls ──────────────────────────────────────
function showTier(tier) {
  currentTier = tier;
  document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
  const btns = document.querySelectorAll('.controls button');
  if (tier === 'rail') btns[0].classList.add('active');
  else if (tier === 'popover') btns[1].classList.add('active');
  else if (tier === 'panel') btns[2].classList.add('active');
}

function resetAll() {
  if (isClosing || isMorphing) return;
  const panel = document.getElementById('reviewPanel');
  if (panel.classList.contains('open')) {
    closePanel();
  } else {
    document.getElementById('popover').classList.remove('visible', 'exiting', 'morphing');
    document.getElementById('mockPage').classList.remove('dimmed', 'compressed');
    document.getElementById('bubbleRail').classList.remove('shifted');
    document.querySelectorAll('.bubble.active').forEach(b => b.classList.remove('active'));
    highlightSection(null);
    activeBubble = null;
    updateAggregate();
    currentMode = 'experts';
    switchMode('experts');
  }
}

// ── Click outside ──────────────────────────────────────
document.addEventListener('click', (e) => {
  const pop = document.getElementById('popover');
  const rail = document.getElementById('bubbleRail');
  const panel = document.getElementById('reviewPanel');

  if (!rail.contains(e.target) && !pop.contains(e.target) && !panel.contains(e.target)) {
    if (pop.classList.contains('visible') && !panel.classList.contains('open')) {
      pop.classList.add('exiting');
      setTimeout(() => {
        pop.classList.remove('visible', 'exiting');
        document.getElementById('mockPage').classList.remove('dimmed');
        document.querySelectorAll('.bubble.active').forEach(b => b.classList.remove('active'));
        highlightSection(null);
        activeBubble = null;
        updateAggregate();
        showTier('rail');
      }, 100);
    }
  }
});

// ── Escape key ─────────────────────────────────────────
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (document.getElementById('reviewPanel').classList.contains('open')) {
      closePanel();
    } else if (document.getElementById('popover').classList.contains('visible')) {
      document.getElementById('popover').classList.add('exiting');
      setTimeout(() => {
        document.getElementById('popover').classList.remove('visible', 'exiting');
        document.getElementById('mockPage').classList.remove('dimmed');
        document.querySelectorAll('.bubble.active').forEach(b => b.classList.remove('active'));
        highlightSection(null);
        activeBubble = null;
        updateAggregate();
        showTier('rail');
      }, 100);
    }
  }
});

// ── Init ───────────────────────────────────────────────
renderBubbles();
</script>
</body>
</html>
